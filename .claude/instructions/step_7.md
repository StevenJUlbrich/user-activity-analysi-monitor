# Step 7: Email Integration (Mailto URL)

## Objective
Generate a mailto URL that opens the user's default email client with pre-filled subject, recipients, and body containing report summary. User must manually attach the Excel report file.

## A. Email Service Implementation

Create `src/client_activity_monitor/model/integrations/email_service.py`:

### Purpose
Create mailto URLs with report information for the user's default email client.

### Implementation

```python
import webbrowser
from urllib.parse import quote
from datetime import datetime
from typing import List, Optional
import pandas as pd
from pathlib import Path
from loguru import logger

class EmailService:
    """
    Handles email generation using mailto URLs.
    Opens default email client with pre-filled information.
    """
    
    def __init__(self):
        """Initialize email service."""
        self.max_body_length = 2000  # Most email clients have URL length limits
        
    def create_email_draft(
        self,
        recipients: List[str],
        report_data: pd.DataFrame,
        report_path: Path,
        user_sid: str,
        last_event_time: datetime
    ) -> bool:
        """
        Create email draft using mailto URL.
        
        Args:
            recipients: List of email addresses
            report_data: DataFrame with report results
            report_path: Path to Excel report file
            user_sid: SID of user who generated report
            last_event_time: Last event time used for analysis
            
        Returns:
            True if email client opened successfully
        """
        try:
            # Generate subject
            subject = self._generate_subject(len(report_data), last_event_time)
            
            # Generate body
            body = self._generate_body(
                report_data,
                report_path,
                user_sid,
                last_event_time
            )
            
            # Create mailto URL
            mailto_url = self._create_mailto_url(recipients, subject, body)
            
            # Open in default email client
            webbrowser.open(mailto_url)
            
            logger.info(f"Email draft created for {len(recipients)} recipients")
            return True
            
        except Exception as e:
            logger.error(f"Failed to create email draft: {e}")
            return False
            
    def _generate_subject(self, user_count: int, last_event_time: datetime) -> str:
        """Generate email subject line."""
        date_str = last_event_time.strftime("%Y-%m-%d")
        if user_count > 0:
            return f"User Activity Report - {user_count} Users Flagged - {date_str}"
        else:
            return f"User Activity Report - No Users Flagged - {date_str}"
            
    def _generate_body(
        self,
        report_data: pd.DataFrame,
        report_path: Path,
        user_sid: str,
        last_event_time: datetime
    ) -> str:
        """
        Generate email body with report summary.
        """
        lines = [
            "User Activity Analysis Report",
            "=" * 40,
            "",
            f"Generated By: {user_sid}",
            f"Generated At: {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}",
            f"Analysis Period: 24 hours before {last_event_time.strftime('%Y-%m-%d %H:%M')}",
            "",
            "SUMMARY",
            "-" * 20,
        ]
        
        if report_data.empty:
            lines.extend([
                "No users found meeting all criteria.",
                "",
                "Criteria: Users must have all four change types (password, email, phone, token) "
                "within the 24-hour analysis window."
            ])
        else:
            lines.extend([
                f"Total Users Flagged: {len(report_data)}",
                "",
                "These users have made ALL of the following changes within the last 24 hours:",
                "  • Password change",
                "  • Email change",
                "  • Phone number change",
                "  • Security token change",
                "",
                "USER LIST",
                "-" * 20,
            ])
            
            # Add user summary (limit to prevent URL length issues)
            max_users_in_email = 20
            for idx, row in report_data.head(max_users_in_email).iterrows():
                user_line = f"• {row['user_id']}"
                
                # Add change summary if space allows
                if 'earliest_change' in row and 'latest_change' in row:
                    earliest = pd.to_datetime(row['earliest_change']).strftime('%H:%M')
                    latest = pd.to_datetime(row['latest_change']).strftime('%H:%M')
                    user_line += f" (changes between {earliest} - {latest})"
                    
                lines.append(user_line)
                
            if len(report_data) > max_users_in_email:
                lines.append(f"... and {len(report_data) - max_users_in_email} more users")
                
        lines.extend([
            "",
            "ACTIONS REQUIRED",
            "-" * 20,
            "1. Review the attached Excel report for complete details",
            "2. Investigate flagged users for potential security concerns",
            "3. Document findings in the incident tracking system",
            "",
            "ATTACHMENT REQUIRED",
            "-" * 20,
            f"Please manually attach the report file:",
            f"{report_path.name}",
            "",
            f"The report file path has been copied to your clipboard.",
            f"Full path: {report_path.absolute()}",
            "",
            "---",
            "This is an automated report from the User Activity Monitor system.",
        ])
        
        return '\n'.join(lines)
        
    def _create_mailto_url(
        self,
        recipients: List[str],
        subject: str,
        body: str
    ) -> str:
        """
        Create properly formatted mailto URL.
        """
        # Join recipients with semicolon (works for most email clients)
        to_string = ';'.join(recipients)
        
        # URL encode subject and body
        subject_encoded = quote(subject)
        body_encoded = quote(body)
        
        # Check URL length and truncate body if needed
        base_url = f"mailto:{to_string}?subject={subject_encoded}&body="
        available_length = self.max_body_length - len(base_url)
        
        if len(body_encoded) > available_length:
            # Truncate body and add note
            truncate_note = "\n\n[Email body truncated due to length limits]"
            truncated_body = body[:available_length - len(quote(truncate_note)) - 100]
            body_encoded = quote(truncated_body + truncate_note)
            logger.warning("Email body truncated due to URL length limits")
            
        mailto_url = f"{base_url}{body_encoded}"
        
        return mailto_url
        
    def format_html_table(self, report_data: pd.DataFrame, max_rows: int = 10) -> str:
        """
        Format DataFrame as HTML table for email (if needed for future enhancement).
        Currently not used due to mailto limitations.
        """
        if report_data.empty:
            return "<p>No data available</p>"
            
        # Select subset of columns for email
        display_columns = ['user_id', 'earliest_change', 'latest_change', 'change_window_hours']
        available_columns = [col for col in display_columns if col in report_data.columns]
        
        subset = report_data[available_columns].head(max_rows)
        
        html = subset.to_html(
            index=False,
            table_id="report-table",
            classes="report-table",
            escape=False
        )
        
        if len(report_data) > max_rows:
            html += f"<p><i>... and {len(report_data) - max_rows} more users</i></p>"
            
        return html
```

## B. Controller Integration

Update the controller to handle email generation:

```python
class MainController:
    def on_generate_email(self):
        """Handle Generate Email Report button."""
        if not self.last_report_data.empty and self.last_report_path:
            try:
                # Get email recipients from config
                email_recipients = self.config_manager.get_app_settings().get('email_recipients', [])
                
                if not email_recipients:
                    self.show_warning(
                        "No Recipients",
                        "No email recipients configured.\n"
                        "Please add recipients in the configuration."
                    )
                    return
                    
                # Get other required data
                user_sid = self.config_manager.get_user_sid()
                last_event_time = datetime.strptime(
                    self.run_analysis_panel.get_last_event_time(),
                    "%Y-%m-%d %H:%M"
                )
                
                # First copy the report path to clipboard
                copy_file_path(self.last_report_path)
                
                # Create email draft
                email_service = EmailService()
                success = email_service.create_email_draft(
                    recipients=email_recipients,
                    report_data=self.last_report_data,
                    report_path=self.last_report_path,
                    user_sid=user_sid,
                    last_event_time=last_event_time
                )
                
                if success:
                    self.show_message(
                        "Email Draft Created",
                        "Email draft opened in your default email client.\n\n"
                        "IMPORTANT: Please manually attach the report file.\n"
                        "The file path has been copied to your clipboard."
                    )
                else:
                    self.show_error(
                        "Email Failed",
                        "Failed to create email draft.\n"
                        "Please check your default email client settings."
                    )
                    
            except Exception as e:
                logger.error(f"Email generation failed: {e}")
                self.show_error("Email Error", str(e))
        else:
            self.show_warning("No Report", "No report available to email")
```

## C. Configuration Update

Ensure email recipients are properly configured in `app_settings.yaml`:

```yaml
app_settings:
  email_recipients: 
    - "security@example.com"
    - "soc-team@example.com"
    - "incident-response@example.com"
```

## D. Key Features

1. **Mailto URL Approach**: Uses system's default email client
2. **Pre-filled Fields**:
   - Recipients from configuration
   - Subject with user count and date
   - Detailed body with report summary

3. **Body Contents**:
   - Report metadata (who generated, when)
   - Summary of findings
   - List of flagged users (limited to prevent URL length issues)
   - Clear instructions to attach the report file
   - Action items for recipients

4. **Attachment Handling**:
   - Cannot automatically attach files via mailto
   - Copies report path to clipboard first
   - Clear instructions in email body
   - Shows reminder dialog after opening email

5. **URL Length Management**:
   - Truncates body if exceeds email client limits
   - Prioritizes essential information

## E. Email Format Example

```
Subject: User Activity Report - 5 Users Flagged - 2024-01-15

Body:
User Activity Analysis Report
========================================

Generated By: A12345
Generated At: 2024-01-15 14:30:45
Analysis Period: 24 hours before 2024-01-15 14:00

SUMMARY
--------------------
Total Users Flagged: 5

These users have made ALL of the following changes within the last 24 hours:
  • Password change
  • Email change
  • Phone number change
  • Security token change

USER LIST
--------------------
• user123 (changes between 10:15 - 13:45)
• user456 (changes between 09:30 - 12:20)
• user789 (changes between 11:00 - 13:55)
• user012 (changes between 08:45 - 13:30)
• user345 (changes between 10:00 - 13:15)

ACTIONS REQUIRED
--------------------
1. Review the attached Excel report for complete details
2. Investigate flagged users for potential security concerns
3. Document findings in the incident tracking system

ATTACHMENT REQUIRED
--------------------
Please manually attach the report file:
user_activity_report_20240115_143045.xlsx

The report file path has been copied to your clipboard.
Full path: C:\path\to\reports\user_activity_report_20240115_143045.xlsx

---
This is an automated report from the User Activity Monitor system.
```

## F. Limitations and Workarounds

1. **No Auto-Attachment**: Mailto URLs cannot include file attachments
2. **URL Length**: Most systems limit URLs to ~2000 characters
3. **Email Client Compatibility**: Formatting may vary by email client
4. **Manual Step Required**: User must attach file manually

## Next Step
After implementing email integration, proceed to Step 8: OneNote Integration for copying formatted data to clipboard.